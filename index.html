<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador de Cães Perdidos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #app {
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 300px;
            background-color: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
        }
        #map {
            flex: 1;
            height: 100%;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .dog-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .dog-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .btn-found {
            background-color: #FF9800;
            margin-top: 10px;
        }
        .btn-found:hover {
            background-color: #F57C00;
        }
        .btn-delete {
            background-color: #f44336;
            margin-top: 10px;
        }
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        .dog-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .dog-status.found {
            background-color: #FF9800;
        }
        .custom-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            background-color: #ddd;
            cursor: pointer;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #success-message {
            display: none;
            background-color: #dff0d8;
            color: #3c763d;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #error-message {
            display: none;
            background-color: #f2dede;
            color: #a94442;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 12px;
        }
        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <h1>Localizador de Cães Perdidos</h1>
            
            <div id="connection-status" class="connection-status">
                Conectando ao Firebase...
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="register">Cadastrar</div>
                <div class="tab" data-tab="list">Listar Todos</div>
                <div class="tab" data-tab="lost">Perdidos</div>
                <div class="tab" data-tab="found">Encontrados</div>
            </div>
            
            <div id="success-message"></div>
            <div id="error-message"></div>
            
            <div id="register-tab" class="tab-content active">
                <form id="dog-form">
                    <div class="form-group">
                        <label for="dog-name">Nome do Cão:</label>
                        <input type="text" id="dog-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dog-breed">Raça:</label>
                        <input type="text" id="dog-breed" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dog-description">Descrição:</label>
                        <textarea id="dog-description" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact-info">Informações de Contato:</label>
                        <input type="text" id="contact-info" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dog-image">Foto do Cão:</label>
                        <input type="file" id="dog-image" accept="image/*" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Localização (clique no mapa):</label>
                        <input type="text" id="location" readonly>
                        <input type="hidden" id="lat">
                        <input type="hidden" id="lng">
                    </div>
                    
                    <button type="submit" id="submit-btn">Cadastrar Cão Perdido</button>
                </form>
            </div>
            
            <div id="list-tab" class="tab-content">
                <h2>Todos os Cães</h2>
                <div id="dogs-list">
                    <div class="loading">Carregando dados do Firebase...</div>
                </div>
            </div>
            
            <div id="lost-tab" class="tab-content">
                <h2>Cães Perdidos</h2>
                <div id="dogs-lost">
                    <div class="loading">Carregando dados do Firebase...</div>
                </div>
            </div>
            
            <div id="found-tab" class="tab-content">
                <h2>Cães Encontrados</h2>
                <div id="dogs-found">
                    <div class="loading">Carregando dados do Firebase...</div>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-storage-compat.min.js"></script>
    
    <!-- Leaflet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBC1N6flDlmnALeqWR3ma3VxO8xXbEIY2M",
            authDomain: "fatecdmd-b8ca7.firebaseapp.com",
            databaseURL: "https://fatecdmd-b8ca7-default-rtdb.firebaseio.com",
            projectId: "fatecdmd-b8ca7",
            storageBucket: "fatecdmd-b8ca7.firebasestorage.app",
            messagingSenderId: "889692626070",
            appId: "1:889692626070:web:9e42661eeb1a3b22a436b7"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Referência para os cães perdidos no database
        const dogsRef = database.ref('lostDogs');
        
        // Inicialização do mapa
        const map = L.map('map').setView([-23.5505, -46.6333], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Variáveis globais
        let selectedLocation = null;
        let markers = [];
        let dogsData = {};
        let isConnected = false;
        
        // Monitorar conexão com Firebase
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            const connected = snapshot.val();
            const statusDiv = document.getElementById('connection-status');
            
            if (connected) {
                statusDiv.textContent = 'Conectado ao Firebase';
                statusDiv.className = 'connection-status connected';
                isConnected = true;
            } else {
                statusDiv.textContent = 'Desconectado do Firebase';
                statusDiv.className = 'connection-status disconnected';
                isConnected = false;
            }
        });
        
        // Função para mostrar mensagem de sucesso
        function showSuccess(message) {
            const successMsg = document.getElementById('success-message');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 5000);
        }
        
        // Função para mostrar mensagem de erro
        function showError(message) {
            const errorMsg = document.getElementById('error-message');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }
        
        // Função para fazer upload da imagem para o Firebase Storage
        async function uploadImage(file, dogId) {
            const storageRef = storage.ref();
            const imageRef = storageRef.child(`dogs/${dogId}/${file.name}`);
            
            try {
                const snapshot = await imageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error('Erro no upload da imagem:', error);
                throw new Error('Falha no upload da imagem');
            }
        }
        
        // Função para salvar cão no Firebase
        async function saveDogToFirebase(dogData, imageFile) {
            if (!isConnected) {
                throw new Error('Não conectado ao Firebase');
            }
            
            try {
                // Gerar ID único para o cão
                const dogKey = dogsRef.push().key;
                
                // Fazer upload da imagem
                const imageUrl = await uploadImage(imageFile, dogKey);
                
                // Adicionar URL da imagem aos dados
                dogData.image = imageUrl;
                dogData.id = dogKey;
                
                // Salvar no Realtime Database
                await dogsRef.child(dogKey).set(dogData);
                
                return { id: dogKey };
            } catch (error) {
                console.error('Erro ao salvar no Firebase:', error);
                throw error;
            }
        }
        
        // Função para atualizar status do cão
        async function updateDogStatus(dogId, found) {
            if (!isConnected) {
                throw new Error('Não conectado ao Firebase');
            }
            
            try {
                await dogsRef.child(dogId).update({ found: found });
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                throw error;
            }
        }
        
        // Função para remover cão do Firebase
        async function removeDogFromFirebase(dogId) {
            if (!isConnected) {
                throw new Error('Não conectado ao Firebase');
            }
            
            try {
                // Remover imagem do Storage (opcional)
                const dog = dogsData[dogId];
                if (dog && dog.image) {
                    try {
                        const imageRef = storage.refFromURL(dog.image);
                        await imageRef.delete();
                    } catch (imageError) {
                        console.log('Erro ao deletar imagem:', imageError);
                        // Continuar mesmo se a imagem não puder ser deletada
                    }
                }
                
                // Remover do Database
                await dogsRef.child(dogId).remove();
            } catch (error) {
                console.error('Erro ao remover cão:', error);
                throw error;
            }
        }
        
        // Troca de abas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remover classe ativa de todas as abas
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Adicionar classe ativa à aba clicada
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                
                // Se a aba for "listar", atualizar a lista
                if (tab.dataset.tab === 'list') {
                    renderDogsList();
                }
            });
        });
        
        // Adicionar evento ao clicar no mapa
        map.on('click', function(e) {
            // Limpar marcador anterior de seleção
            if (selectedLocation) {
                map.removeLayer(selectedLocation);
            }
            
            // Definir nova localização
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            document.getElementById('location').value = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
            
            // Adicionar marcador temporário
            selectedLocation = L.marker([lat, lng]).addTo(map);
            selectedLocation.bindPopup('Local selecionado').openPopup();
        });
        
        // Envio do formulário
        document.getElementById('dog-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvando...';
            
            // Esconder mensagens anteriores
            document.getElementById('success-message').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            
            // Verificar conexão
            if (!isConnected) {
                showError('Não conectado ao Firebase. Verifique sua conexão com a internet.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cadastrar Cão Perdido';
                return;
            }
            
            // Validar formulário
            if (!document.getElementById('lat').value || !document.getElementById('lng').value) {
                showError('Por favor, selecione um local no mapa.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cadastrar Cão Perdido';
                return;
            }
            
            // Obter os dados do formulário
            const dogName = document.getElementById('dog-name').value;
            const dogBreed = document.getElementById('dog-breed').value;
            const dogDescription = document.getElementById('dog-description').value;
            const contactInfo = document.getElementById('contact-info').value;
            const imageFile = document.getElementById('dog-image').files[0];
            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            
            try {
                // Preparar dados para salvar
                const dogData = {
                    name: dogName,
                    breed: dogBreed,
                    description: dogDescription,
                    contactInfo: contactInfo,
                    location: {
                        lat: lat,
                        lng: lng
                    },
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    found: false
                };
                
                // Salvar no Firebase
                await saveDogToFirebase(dogData, imageFile);
                
                // Limpar formulário
                document.getElementById('dog-form').reset();
                document.getElementById('lat').value = '';
                document.getElementById('lng').value = '';
                document.getElementById('location').value = '';
                
                if (selectedLocation) {
                    map.removeLayer(selectedLocation);
                    selectedLocation = null;
                }
                
                showSuccess('Cão cadastrado com sucesso no Firebase!');
                
                // Mudar para a aba de listagem
                document.querySelector('.tab[data-tab="list"]').click();
                
            } catch (error) {
                console.error("Erro ao cadastrar:", error);
                showError(`Erro ao cadastrar o cão: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Cadastrar Cão Perdido';
            }
        });
        
        // Função para criar marcador personalizado com a imagem do cão
        function createDogMarker(dog) {
            const icon = L.divIcon({
                html: `<img src="${dog.image}" class="custom-marker" width="50" height="50">`,
                className: '',
                iconSize: [50, 50]
            });
            
            const marker = L.marker([dog.location.lat, dog.location.lng], {icon: icon}).addTo(map);
            
            // Popup com informações do cão
            const popupContent = `
                <div style="width:200px; text-align:center;">
                    <img src="${dog.image}" style="width:100%; height:150px; object-fit:cover; border-radius:4px; margin-bottom:10px;">
                    <h3>${dog.name}</h3>
                    <p><strong>Raça:</strong> ${dog.breed}</p>
                    <p>${dog.description}</p>
                    <p><strong>Contato:</strong> ${dog.contactInfo}</p>
                    <p><strong>Status:</strong> ${dog.found ? 'Encontrado' : 'Perdido'}</p>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            return marker;
        }
        
        // Função para mostrar card de cão na lista
        function createDogCard(dog) {
            const dogCard = document.createElement('div');
            dogCard.className = 'dog-card';
            dogCard.style.position = 'relative';
            
            // Status do cão (perdido ou encontrado)
            const statusLabel = dog.found ? 'Encontrado' : 'Perdido';
            const statusClass = dog.found ? 'found' : '';
            
            dogCard.innerHTML = `
                <div class="dog-status ${statusClass}">${statusLabel}</div>
                <img src="${dog.image}" alt="${dog.name}" style="${dog.found ? 'opacity: 0.6;' : ''}">
                <h3>${dog.name}</h3>
                <p><strong>Raça:</strong> ${dog.breed}</p>
                <p>${dog.description.substring(0, 100)}${dog.description.length > 100 ? '...' : ''}</p>
                <p><strong>Contato:</strong> ${dog.contactInfo}</p>
                <button class="locate-btn" data-lat="${dog.location.lat}" data-lng="${dog.location.lng}">Localizar no Mapa</button>
                ${!dog.found ? `<button class="btn-found" data-id="${dog.id}">Marcar Como Encontrado</button>` : ''}
                <button class="btn-delete" data-id="${dog.id}">Remover</button>
            `;
            
            // Adicionar evento ao botão de localizar
            dogCard.querySelector('.locate-btn').addEventListener('click', function() {
                const lat = parseFloat(this.dataset.lat);
                const lng = parseFloat(this.dataset.lng);
                map.setView([lat, lng], 16);
                
                // Encontrar e abrir o popup do marcador correspondente
                markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (markerLatLng.lat === lat && markerLatLng.lng === lng) {
                        marker.openPopup();
                    }
                });
            });
            
            // Adicionar evento ao botão "Marcar Como Encontrado"
            if (!dog.found) {
                dogCard.querySelector('.btn-found').addEventListener('click', async function() {
                    if (confirm("Confirmar que o cão foi encontrado?")) {
                        const btn = this;
                        btn.disabled = true;
                        btn.textContent = 'Atualizando...';
                        
                        try {
                            await updateDogStatus(this.dataset.id, true);
                            showSuccess('Cão marcado como encontrado com sucesso!');
                        } catch (error) {
                            console.error('Erro ao atualizar status:', error);
                            showError(`Erro ao atualizar status: ${error.message}`);
                            btn.disabled = false;
                            btn.textContent = 'Marcar Como Encontrado';
                        }
                    }
                });
            }
            
            // Adicionar evento ao botão "Remover"
            dogCard.querySelector('.btn-delete').addEventListener('click', async function() {
                if (confirm("Tem certeza que deseja remover este cão do sistema?")) {
                    const btn = this;
                    btn.disabled = true;
                    btn.textContent = 'Removendo...';
                    
                    try {
                        await removeDogFromFirebase(this.dataset.id);
                        showSuccess('Cão removido com sucesso!');
                    } catch (error) {
                        console.error('Erro ao remover cão:', error);
                        showError(`Erro ao remover cão: ${error.message}`);
                        btn.disabled = false;
                        btn.textContent = 'Remover';
                    }
                }
            });
            
            return dogCard;
        }
        
        // Função para renderizar as listas
        function renderDogsList() {
            const dogsList = document.getElementById('dogs-list');
            const dogsLost = document.getElementById('dogs-lost');
            const dogsFound = document.getElementById('dogs-found');
            
            // Limpar listas
            dogsList.innerHTML = '';
            dogsLost.innerHTML = '';
            dogsFound.innerHTML = '';
            
            // Limpar marcadores atuais
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            const dogs = Object.values(dogsData);
            
            if (dogs.length === 0) {
                dogsList.innerHTML = '<p>Nenhum cão cadastrado ainda.</p>';
                dogsLost.innerHTML = '<p>Nenhum cão perdido registrado.</p>';
                dogsFound.innerHTML = '<p>Nenhum cão encontrado registrado.</p>';
                return;
            }
            
            // Contadores para estatísticas
            let lostCount = 0;
            let foundCount = 0;
            
            // Adicionar cada cão ao mapa e às listas apropriadas
            dogs.forEach((dog) => {
                // Adicionar ao mapa (apenas se não estiver marcado como encontrado)
                if (!dog.found) {
                    const marker = createDogMarker(dog);
                    markers.push(marker);
                    lostCount++;
                } else {
                    foundCount++;
                }
                
                // Adicionar à lista geral
                const card = createDogCard(dog);
                dogsList.appendChild(card);
                
                // Adicionar à lista apropriada (perdidos ou encontrados)
                if (dog.found) {
                    const foundCard = createDogCard(dog);
                    dogsFound.appendChild(foundCard);
                } else {
                    const lostCard = createDogCard(dog);
                    dogsLost.appendChild(lostCard);
                }
            });
            
            // Mostrar mensagens se não houver cães em uma categoria
            if (lostCount === 0) {
                dogsLost.innerHTML = '<p>Nenhum cão perdido registrado.</p>';
            }
            
            if (foundCount === 0) {
                dogsFound.innerHTML = '<p>Nenhum cão encontrado registrado.</p>';
            }
            
            // Ajustar o mapa para mostrar todos os marcadores
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Inicializar a aplicação quando a página carregar
        window.addEventListener('load', function() {
            console.log('Página carregada, inicializando Firebase...');
            
            // Aguardar um pouco para garantir que os scripts carregaram
            setTimeout(() => {
                if (typeof firebase !== 'undefined') {
                    initializeFirebase();
                } else {
                    console.error('Firebase SDK não carregou');
                    const statusDiv = document.getElementById('connection-status');
                    statusDiv.textContent = 'Firebase SDK não carregou';
                    statusDiv.className = 'connection-status disconnected';
                    
                    // Usar localStorage como fallback
                    loadFromLocalStorage();
                }
            }, 1000);
        });
        
        // Também tentar inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado');
        });
    </script>
</body>
</html>
